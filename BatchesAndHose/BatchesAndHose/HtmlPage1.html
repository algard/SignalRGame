<!DOCTYPE html>
<html>
<head>
    <title>SignalR Simple Chat</title>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>
    <body>
        <div id="playerDetails" class="content">
            <input size="10" name="displayname" id="displayname" /> 
            <input type="button" id="newGame" value="New Game"/>
        </div>
    <hr/>
        <div id="canvasContainer" class="content">
            <div class="canvas"></div>
        </div>
    <hr/>
        <div id="bottom" class="content">
			<div id="theme" class="dark">
				<ul class="room">
  				<form>
   	 				<input id="message-box" name="message-box" type="text"  placeholder="Enter message..." title="Enter message..."/>
    				<input id="message-send" name="message-send" type="button" value="Send"/>
 				</form>
  				</ul>
  			</div>				
		</div>
            

        <!--Script references. -->
        <!--Reference the jQuery library. -->
        <script src="Scripts/jquery-1.9.0.min.js" ></script>
        <!--Reference the SignalR library. -->
        <script src="Scripts/jquery.signalR-1.0.0-rc2.js"></script>
        <!--Reference the autogenerated SignalR hub script. -->
        <script src="/signalr/hubs"></script>
        <!--Add script to update the page and send messages.--> 
        <script type="text/javascript">
            $(function () {
                // Declare a proxy to reference the hub. 
                var chat = $.connection.chatHub;
                var lastSentX;
                var lastX = 0;
                var canvasWidth = 800;
                var canvasHeight = 800;
                var playerHeight = 50;

                /*
                 * broadcastMessage - recieve a message from another player
                 */
                chat.client.broadcastMessage = function (name, message) {
                    // Html encode display name and message. 
                    var encodedName = $('<strong />').text(name + ":").html();
                    var encodedMsg = $('<span />').text(message).html();
                    var count = $('.room li').size();
                    var yourName = $('#displayname').val();
                    var time = new Date();
                    // Add the message to the page.
                    
                    if (count < 3) {
                        if (name === yourName) {
                            $('.room').append('<li class="msg playerOne">' +
                                '<img alt="">' +
                                '<p>' +
                                '<strong>' + name.substring(0, 5) + ': </strong>' +
                                '<span class="msgText">' + message.substring(0, 21) + '</span>' +
                                '<time>' + time.toTimeString().substring(0, 8) + '</time>' +
                                '</p>' +
                                '</li>');
                        } else {
                            $('.room').append('<li class="msg playerTwo">' +
                               '<img alt="">' +
                               '<p>' +
                               '<strong>' + name.substring(0, 5) + ': </strong>' +
                               '<span class="msgText p2">' + message.substring(0, 21) + '</span>' +
                               '<time>' + time.toTimeString().substring(0, 8) + '</time>' +
                               '</p>' +
                               '</li>');
                        }
                        
                    } else {
                        $('.room li:first').remove();
                        if (name === yourName) {
                            $('.room').append('<li class="msg playerOne">' +
                                '<img alt="">' +
                                '<p>' +
                                '<strong>' + name.substring(0, 5) + ': </strong>' +
                                '<span class="msgText">' + message.substring(0, 21) + '</span>' +
                                '<time>' + time.toTimeString().substring(0, 8) + '</time>' +
                                '</p>' +
                                '</li>');
                        } else {
                            $('.room').append('<li class="msg playerTwo">' +
                               '<img alt="">' +
                               '<p>' +
                               '<strong>' + name.substring(0, 5) + ': </strong>' +
                               '<span class="msgText p2">' + message.substring(0, 21) + '</span>' +
                               '<time>' + time.toTimeString().substring(0, 8) + '</time>' +
                               '</p>' +
                               '</li>');
                        }
                    }
                };

                /*
                 * movePlayer - notify the client that a player has moved
                 */
                chat.client.movePlayer = function (name, x) {
                    $('#player' + name).css('left', x);
                };

                /*
                 * addPlayer - notify the client that a player has been added to the game
                 */
                chat.client.addPlayer = function (newPlayerName, x) {
                    if (newPlayerName == $('#displayname').val()) {
                        lastX = x;
                    }

                    var playerDiv = $('<div />', {
                        id: 'player' + newPlayerName,
                        "class": 'player'
                    });

                    var name = $('<span />', {
                        "class": 'playerName'
                    }).text(newPlayerName);

                    playerDiv.append(name);
                    playerDiv.css('top', (canvasHeight - playerHeight) + 'px');
                    playerDiv.css('left', x + 'px');

                    $("body").append(playerDiv);
                };


                /*
                 * init code
                 */
                // Get the user name and store it to prepend to messages.
                var playerName = prompt('Enter your name:', '');
                $('#displayname').val(playerName);
                // Set initial focus to message input box.  
                $('#message-box').focus();
                // Start the connection.
                $.connection.hub.start().done(function () {
                    chat.server.addNewPlayer($('#displayname').val());
           
                    
                    $('#message-send').click(function () {
                        // Call the Send method on the hub. 
                        chat.server.send($('#displayname').val(), $('#message-box').val());


                        // Clear text box and reset focus for next comment. 
                        $('#message-box').val('').focus();
                    });


                    /*
                     * stop moving
                     */
                    $("body").keyup(function (event) {
                        // todo: use moveStartLocation and lastX(current x?) to figure out 
                        switch (event.keyCode) {
                        case 37: 
                            chat.server.move($('#displayname').val(), -25);
                            break;
                        case 39:
                            chat.server.move($('#displayname').val(), 25);
                            break;
                        }
                    });
                    

                });
            });
        </script>
    </body>
</html>
