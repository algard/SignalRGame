<!DOCTYPE html>
<html>
<head>
    <title>SignalR Simple Chat</title>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>
    <body>
        
        <div id="playerDetails">
            <label for="displayname">Player Name:</label><input name="displayname" id="displayname" />
        </div>
    
        <div class="canvas"></div>


        <div id="bottom">
			<div id="theme" class="dark">
			    <ul class="room">
				    
			        <!--<li class="msg playerOne">
			                <img alt="">
			                <p>
			                    <strong>Jim sauce: </strong>
			                    <span class="msg">hello world</span>
			                    <time>20:23</time>
			                </p>
			            </li>-->
  
			        <!--<li class="msg playerTwo">
			                <img alt="">
			                <p>
			                    <strong>Jimbob: </strong>
			                    <span class="msg">blah blah blah blah blah blah blah</span>
			                    <time>20:25</time>
			                </p>
			            </li>-->
  
			        <!--<li class="msg playerOne">
			                <img alt="">
			                <p>
			                    <strong>Jim sauce: </strong>
			                    <span class="msg">hello world you are stupid</span>
			                    <time>20:23</time>
			                </p>
			            </li>-->
    
			        <form>
			            <input id="message-box" name="message-box" type="text"  placeholder="Enter message..." title="Enter message..."/>
			            <input id="message-send" name="message-send" type="button" value="Send"/>
			        </form>   
			    </ul>
			</div>				
		</div>


        <!--Script references. -->
        <!--Reference the jQuery library. -->
        <script src="Scripts/jquery-1.9.0.min.js" ></script>
        <!--Reference the SignalR library. -->
        <script src="Scripts/jquery.signalR-1.0.0-rc2.js"></script>
        <!--Reference the autogenerated SignalR hub script. -->
        <script src="/signalr/hubs"></script>
        <!--Add script to update the page and send messages.--> 
        <script type="text/javascript">
            $(function () {
                // Declare a proxy to reference the hub. 
                var chat = $.connection.chatHub;

                /*
                 * broadcastMessage - recieve a message from another player
                 */
                chat.client.broadcastMessage = function (name, message) {
                    // Html encode display name and message. 
                    var encodedName = $('<strong />').text(name + ":").html();
                    var encodedMsg = $('<span />').text(message).html();
                    var count = $('.room li').size();
                    var yourName = $('#displayname').val();
                    // Add the message to the page.
                    
                    if (count < 3) {
                        if (name === yourName) {
                            $('.room').append('<li class="msg playerOne">' +
                                '<img alt="">' +
                                '<p>' +
                                '<strong>' + name + ': </strong>' +
                                '<span class="msgText">' + message + count + '</span>' +
                                '<time>20:23</time>' +
                                '</p>' +
                                '</li>');
                        } else {
                            $('.room').append('<li class="msg playerTwo">' +
                               '<img alt="">' +
                               '<p>' +
                               '<strong>' + name + ': </strong>' +
                               '<span class="msgText">' + message + count + '</span>' +
                               '<time>20:23</time>' +
                               '</p>' +
                               '</li>');
                        }
                        
                    } else {
                        $('.room li:first').remove();
                        if (name === yourName) {
                            $('.room').append('<li class="msg playerOne">' +
                                '<img alt="">' +
                                '<p>' +
                                '<strong>' + name + ': </strong>' +
                                '<span class="msgText">' + message + count + '</span>' +
                                '<time>20:23</time>' +
                                '</p>' +
                                '</li>');
                        } else {
                            $('.room').append('<li class="msg playerTwo">' +
                               '<img alt="">' +
                               '<p>' +
                               '<strong>' + name + ': </strong>' +
                               '<span class="msgText">' + message + count + '</span>' +
                               '<time>20:23</time>' +
                               '</p>' +
                               '</li>');
                        }
                    }
                };

                /*
                 * movePlayer - notify the client that a player has moved
                 */
                chat.client.movePlayer = function (name, x, y) {
                    $('#player' + name).css('top', y);
                    $('#player' + name).css('left', x);
                };

                /*
                 * addPlayer - notify the client that a player has been added to the game
                 */
                chat.client.addPlayer = function (newPlayerName, x, y) {
                    // if (newPlayerName == $('#displayname').val()) {
                    //     return;
                    // }

                    var playerScoreBar = $('<div />', {
                        id: 'ScoreBar' + newPlayerName,
                        "class": 'progressbar-outer'
                    });

                    var score = $('<div />', {
                        id: 'Score' + newPlayerName,
                        "class": 'progressbar-inner'
                    }).text(newPlayerName);

                    playerScoreBar.append(score);

                    var playerDiv = $('<div />', {
                        id: 'player' + newPlayerName,
                        "class": 'player'
                    }).css('background-color', '#' + parseInt(x-100) + parseInt(y));

                    var name = $('<span />', {
                        "class": 'playerName'
                    }).text(newPlayerName);

                    playerDiv.append(name);
                    playerDiv.css('top', y + 'px');
                    playerDiv.css('left', x + 'px');

                    $("body").append(playerDiv);
                    $(".dark").append(playerScoreBar);
                };


                /*
                 * init code
                 */
                // Get the user name and store it to prepend to messages.
                var playerName = prompt('Enter your name:', '');
                $('#displayname').val(playerName);
                // Set initial focus to message input box.  
                $('#message-box').focus();
                // Start the connection.
                $.connection.hub.start().done(function () {
                    chat.server.addNewPlayer($('#displayname').val());
                    $('#message-send').click(function () {
                        // Call the Send method on the hub. 
                        chat.server.send($('#displayname').val(), $('#message-box').val());


                        // Clear text box and reset focus for next comment. 
                        $('#message-box').val('').focus();
                    });
                });
            });
        </script>
    </body>
</html>
